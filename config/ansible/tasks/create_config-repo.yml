- name: Install upgrade-config-repo.sh
  template:
    src: "{{ sf_templates_dir }}/upgrade-config-repo.sh.j2"
    dest: "/usr/local/bin/upgrade-config-repo.sh"
    mode: 0555

- stat: path=/root/config
  register: config_done

- name: Make a first admin connexion through SF SSO (force sf_users admin id:1)
  command: sfmanager sf_user list
  when: config_done.stat.exists != True

# Create the config repo
- name: Copy default resources file
  command: cp /usr/share/sf-config/config-repo/resources/resources.yaml /root/resources.yaml
  when: config_done.stat.exists != True

- name: Change default admin email in default resources file
  replace:
      dest: /root/resources.yaml
      regexp: '@sftests.com'
      replace: '@{{ fqdn }}'
  when: config_done.stat.exists != True

- name: Create empty resources file
  shell: "echo 'resources: {}' > /root/empty_resources.yaml"
  when: config_done.stat.exists != True

- name: Create config repository resources
  command: /usr/local/bin/resources.sh direct_apply /root/empty_resources.yaml /root/resources.yaml
  when: config_done.stat.exists != True

# Clone the config repo
- command: mktemp -d
  register: conf_tmp
  when: config_done.stat.exists != True

- name: Clone the config repository
  git: repo=git+ssh://gerrit/config
       dest={{ conf_tmp.stdout }}
  when: config_done.stat.exists != True

# Prepare the config repo
- name: Sync /usr/share/sf-config/config-repo/ in the config repo
  command: rsync -av /usr/share/sf-config/config-repo/ {{ conf_tmp.stdout }}/
  when: config_done.stat.exists != True

- name: Copy default JJB definitions in /usr/share/sf-config/config-repo/
  template:
    src: "{{ sf_templates_dir }}/_default_jobs.yaml.j2"
    dest: "{{ conf_tmp.stdout }}/jobs/_default_jobs.yaml"
  when: config_done.stat.exists != True

- name: Copy default resources file
  command: mv /root/resources.yaml "{{ conf_tmp.stdout }}/resources/resources.yaml"
  when: config_done.stat.exists != True

# Commit
- name: Push config repo
  command: git {{ item }} chdir={{ conf_tmp.stdout }}
  with_items:
    - "add -A"
    - "commit -m 'Initialize config repository'"
    - "push origin master"
  when: config_done.stat.exists != True

- command: mv {{ conf_tmp.stdout }} /root/config
  when: config_done.stat.exists != True
