---
# This playbook reconfigure service based on config repo.
#

# Check config repo HEAD and update /root/config copy for each services
- hosts: localhost
  tasks:
    - name: Get config sha1
      command: git ls-remote -h http://{{ '{{' }} fqdn {{ '}}' }}/r/config.git
      register: configsha

- hosts: gateway:jenkins:zuul:nodepool:managesf:gerrit{% if 'gerritbot' in roles %}:gerritbot{% endif %}{% if 'mirror' in roles %}:mirror{% endif %}{% if 'repoxplorer' in roles %}:repoxplorer{% endif %}

  tasks:
    - include: tasks/update_configrepo.yaml

- hosts: jenkins
  roles:
    - {role: 'sf-jenkins', action: 'update'}

{% for host in inventory %}{% if 'sf-zuul' in host['rolesname'] %}
- hosts: {{ host['hostname'] }}
  roles:
    - {role: 'sf-zuul', action: 'update', zuul_services: {{ host["zuul_services"] }}}

{% endif %}{% endfor %}

{% if 'gerritbot' in roles %}
- hosts: gerritbot
  roles:
    - {role: 'sf-gerritbot', action: 'update'}
{% endif %}

{% for host in inventory %}{% if 'sf-nodepool' in host['rolesname'] %}
- hosts: {{ host['hostname'] }}
  roles:
    - {role: 'sf-nodepool', action: 'update', nodepool_services: {{ host["nodepool_services"] }}}

{% endif %}{% endfor %}

- hosts: gerrit
  tasks:
    # TODO: move this task to a replication role update action
    - include: tasks/gerrit_replication_update.yaml
  roles:
    - {role: 'sf-gerrit', action: 'update'}

- hosts: managesf
  roles:
    - {role: 'sf-managesf', action: 'update'}

{% if 'mirror' in roles %}
- hosts: mirror
  roles:
    - {role: 'sf-mirror', action: 'update'}
{% endif %}

{% if 'repoxplorer' in roles %}
- hosts: repoxplorer
  roles:
    - {role: 'sf-repoxplorer', action: 'update'}
{% endif %}

- hosts: gateway
  roles:
    - {role: 'sf-gateway', action: 'update'}
