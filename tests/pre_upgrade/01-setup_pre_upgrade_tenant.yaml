---
- hosts: localhost
  gather_facts: no
  tasks:
    - name: create private network
      os_network:
          cloud: '{{ pre_upgrade_cloud }}'
          state: present
          name: '{{ private_network }}'

    - name: create private subnet
      os_subnet:
          cloud: '{{ pre_upgrade_cloud }}'
          state: present
          network_name: '{{ private_network }}'
          name: '{{ private_network }}'
          cidr: '{{ cidr }}'
          dns_nameservers:
             - 8.8.8.8
             - 8.8.8.4

    - name: create router
      os_router:
          cloud: '{{ pre_upgrade_cloud }}'
          state: present
          name: router
          network: '{{ public_network }}'
          interfaces:
            - '{{ private_network }}'

    - name: create security group
      os_security_group:
          cloud: '{{ pre_upgrade_cloud }}'
          state: present
          name: '{{ project }}'
          # TODO: prepare a patch for production
          # https://github.com/ansible/ansible/pull/22628
          # egress_default_rules: absent
          description: security group for '{{ project }}' instances

    - name: security group allow icmp
      os_security_group_rule:
          cloud: '{{ pre_upgrade_cloud }}'
          security_group: '{{ project }}'
          direction: '{{ item }}'
          protocol: icmp
          remote_ip_prefix: 0.0.0.0/0
      with_items:
          - egress
          - ingress

    - name: create ingress security group rules
      os_security_group_rule:
          cloud: '{{ pre_upgrade_cloud }}'
          security_group: '{{ project }}'
          direction: ingress
          protocol: '{{ item.protocol | default("tcp")}}'
          port_range_min: '{{ item.min_port }}'
          port_range_max: '{{ item.max_port | default(item.min_port) }}'
          remote_ip_prefix: '{{ remote_ip_prefix | default("0.0.0.0/0") }}'
      with_items: '{{ ingress_ports }}'

    - name: create egress security group rules for private only
      os_security_group_rule:
          cloud: '{{ pre_upgrade_cloud }}'
          security_group: '{{ project }}'
          direction: egress
          protocol: '{{ item }}'
          port_range_min: 1
          port_range_max: 65535
          remote_group: '{{ project }}'
      with_items:
          - tcp
          - udp

    - name: create security group rules for metadata
      os_security_group_rule:
          cloud: '{{ pre_upgrade_cloud }}'
          security_group: '{{ project }}'
          direction: '{{ item }}'
          protocol: tcp
          port_range_min: 80
          port_range_max: 80
          remote_ip_prefix: 169.254.169.0/24
      with_items:
          - ingress
          - egress

    - name: create egress security group rules
      os_security_group_rule:
          cloud: '{{ pre_upgrade_cloud }}'
          security_group: '{{ project }}'
          direction: egress
          protocol: '{{ item.protocol | default("tcp")}}'
          port_range_min: '{{ item.min_port }}'
          port_range_max: '{{ item.max_port | default(item.min_port) }}'
      with_items: '{{ egress_ports }}'
