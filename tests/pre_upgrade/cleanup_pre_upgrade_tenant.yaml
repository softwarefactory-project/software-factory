---
- hosts: localhost
  gather_facts: no
  tasks:
      - name: Destroy old instance
        os_server:
            cloud: '{{ pre_upgrade_cloud }}'
            state: absent
            name: '{{ item.hostname }}'
        with_items: '{{ instances }}'

      - name: Cleanup old ports
        os_port:
            cloud: '{{ pre_upgrade_cloud }}'
            name: '{{ item.hostname }}'
            network: '{{ private_network }}'
            state: absent
        with_items: '{{ instances }}'

      - name: Cleanup snasphots and volumes
        shell: 'scripts/cleanup_pre_upgrade_tenant.sh {{item.hostname }}'
        with_items: '{{ instances }}'
